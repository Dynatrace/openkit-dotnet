version: 1.4.3.{build}

# environment variables
environment:
  COVERALLS_REPO_TOKEN:
    secure: IH0irnGyWP3Z9jcxBz6LsnYIH2pStkwq23/tMRWFCFswYfTA5DvVPTp4pbz9r0Hi

# Build with Visual Studio 2017
image: Visual Studio 2017

# Build Release and Coverage (2 build jobs)
configuration:
- Release
- Coverage

# fail fast (No need to build Failing Release & Coverage builds)
matrix:
  fast_finish: true

# Assembly patching for .NET and .NET Core projects
assembly_info:
  patch: true
  file: '**\AssemblyInfo.*'
  assembly_version: $(appveyor_build_version)
  assembly_file_version: $(appveyor_build_version)
  assembly_informational_version: $(appveyor_build_version)
dotnet_csproj:
  patch: true
  file: '**\openkit-dotnetcore-*.csproj'
  version: $(appveyor_build_version)
  package_version: $(appveyor_build_version)
  assembly_version: $(appveyor_build_version)
  file_version: $(appveyor_build_version)
  informational_version: $(appveyor_build_version)

# restore NuGet packages
before_build:
- cmd: nuget restore

# build
build:
  project: openkit-dotnet.sln
  verbosity: minimal
  
# run tests with code coverage only for Coverage configuration
for:
-
  matrix:
    only:
      - configuration: Coverage

  test_script:
  - ps: |
      .\callTest.ps1 -option Coverage
  after_test: 
  - ps: |
      if ("$Env:APPVEYOR_PULL_REQUEST_NUMBER" -eq "" -And "$Env:APPVEYOR_REPO_NAME" -eq "Dynatrace/openkit-dotnet")
      {
        packages\coveralls.io.1.4.2\tools\coveralls.net.exe --opencover .\coverage.xml -r $Env:COVERALLS_REPO_TOKEN
      }
      else
      {
          Write-Host("Skipping coveralls.io upload")
          Write-Host("APPVEYOR_PULL_REQUEST_NUMBER=$Env:APPVEYOR_PULL_REQUEST_NUMBER")
          Write-Host("APPVEYOR_REPO_NAME=$Env:APPVEYOR_REPO_NAME")
      }
-
  matrix:
    only:
      - configuration: Release
  after_build:
  - ps: |
      .\callTest.ps1 -option Release
